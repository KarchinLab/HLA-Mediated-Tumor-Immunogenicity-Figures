A1_supertype=c('HLA-A01:01','HLA-A26:01','HLA-A26:02','HLA-A26:03','HLA-A30:02','HLA-A30:03','HLA-A30:04',
               'HLA-A32:01','HLA-A01:03','HLA-A01:04','HLA-A01:06','HLA-A01:07','HLA-A01:08','HLA-A01:09',
               'HLA-A01:10','HLA-A01:11','HLA-A01:12','HLA-A01:14','HLA-A01:15','HLA-A26:04','HLA-A26:05',
               'HLA-A26:06','HLA-A26:07','HLA-A26:08','HLA-A26:09','HLA-A26:10','HLA-A26:11','HLA-A26:12','HLA-A26:13','HLA-A26:14',
               'HLA-A26:15','HLA-A26:17','HLA-A26:18','HLA-A26:19','HLA-A26:21','HLA-A26:23','HLA-A26:24','HLA-A26:26','HLA-A30:06',
               'HLA-A30:09','HLA-A30:12','HLA-A32:02','HLA-A32:05','HLA-A32:06','HLA-A32:07','HLA-A32:09','HLA-A32:10','HLA-A36:01',
               'HLA-A36:02','HLA-A36:04','HLA-A25:01','HLA-A25:02','HLA-A25:04','HLA-A26:22','HLA-A31;10','HLA-A32:03','HLA-A32:04',
               'HLA-A32:08','HLA-A36:03','HLA-A74:10','HLA-A80:01','HLA-A30:01','HLA-A30:08','HLA-A30:11','HLA-A30:14','HLA-A30:15',
               'HLA-A02:52','HLA-A30:13','HLA-A68:06','HLA-A68:07','HLA-A29:02','HLA-A29:01','HLA-A29:03','HLA-A29:05','HLA-A29:06',
               'HLA-A29:09','HLA-A29:10','HLA-A29:11','HLA-A29:12','HLA-A29:13')
A2_supertype=c('HLA-A02:01','HLA-A02:02','HLA-A02:03','HLA-A02:04','HLA-A02:05','HLA-A02:06','HLA-A02:07','HLA-A02:14','HLA-A02:17',
               'HLA-A68:02','HLA-A69:01','HLA-A02:09','HLA-A02:11','HLA-A02:12','HLA-A02:13','HLA-A02:15','HLA-A02:16','HLA-A02:18',
               'HLA-A02:19','HLA-A02:20','HLA-A02:21','HLA-A02:22','HLA-A02:24','HLA-A02:25','HLA-A02:26','HLA-A02:27','HLA-A02:28',
               'HLA-A02:30','HLA-A02:31','HLA-A02:36','HLA-A02:37','HLA-A02:38','HLA-A02:39','HLA-A02:40','HLA-A02:43','HLA-A02:44',
               'HLA-A02:45','HLA-A02:46','HLA-A02:47','HLA-A02:48','HLA-A02:49','HLA-A02:51','HLA-A02:54','HLA-A02:56','HLA-A02:57',
               'HLA-A02:58','HLA-A02:59','HLA-A02:61','HLA-A02:62','HLA-A02:63','HLA-A02:66','HLA-A02:67','HLA-A02:68','HLA-A02:69',
               'HLA-A02:70','HLA-A02:71','HLA-A02:72','HLA-A02:74','HLA-A02:75','HLA-A02:77','HLA-A02:78','HLA-A02:79','HLA-A02:82',
               'HLA-A02:83','HLA-A02:85','HLA-A02:86','HLA-A68:27','HLA-A68:28','HLA-A02:41','HLA-A02:42','HLA-A02:50','HLA-A02:60',
               'HLA-A02:73','HLA-A02:84','HLA-A68:15')
A3_supertype=c('HLA-A03:01','HLA-A11:01','HLA-A31:01','HLA-A33:01','HLA-A33:03','HLA-A66:01','HLA-A68:01','HLA-A74:01','HLA-A03:02',
               'HLA-A03:04','HLA-A03:05','HLA-A03:06','HLA-A03:07','HLA-A03:08','HLA-A03:10','HLA-A03:12','HLA-A03:13','HLA-A03:14',
               'HLA-A03:16','HLA-A03:17','HLA-A11:02','HLA-A11:03','HLA-A11:04','HLA-A11:05','HLA-A11:07','HLA-A11:08','HLA-A11:09',
               'HLA-A11:10','HLA-A11:12','HLA-A11:13','HLA-A11:14','HLA-A11:15','HLA-A11:16','HLA-A11:20','HLA-A11:21','HLA-A11:23',
               'HLA-A31:03','HLA-A31:04','HLA-A31:05','HLA-A31:06','HLA-A31:09','HLA-A31:11','HLA-A33:04','HLA-A33:05','HLA-A33:06',
               'HLA-A33:07','HLA-A34:02','HLA-A34:03','HLA-A34:04','HLA-A34:06','HLA-A66:02','HLA-A66:03','HLA-A66:04','HLA-A68:03',
               'HLA-A68:04','HLA-A68:08','HLA-A68:09','HLA-A68:10','HLA-A68:12','HLA-A68:13','HLA-A68:14','HLA-A68:16','HLA-A68:19',
               'HLA-A68:21','HLA-A68:22','HLA-A68:24','HLA-A68:25','HLA-A68:26','HLA-A74:02','HLA-A74:03','HLA-A74:04','HLA-A74:05',
               'HLA-A74:07','HLA-A74:08','HLA-A74:09','HLA-A74:11','HLA-A02:65','HLA-A02:80','HLA-A03:09','HLA-A11:06','HLA-A11:22',
               'HLA-A31:12','HLA-A68:05','HLA-A68:20','HLA-A68:23','HLA-A74:06')
A24_supertype=c('HLA-A23:01','HLA-A24:02','HLA-A23:02','HLA-A23:03','HLA-A23:04','HLA-A23:06','HLA-A23:07','HLA-A23:08','HLA-A23:10',
                'HLA-A24:03','HLA-A24:05','HLA-A24:06','HLA-A24:08','HLA-A24:09','HLA-A24:10','HLA-A24:11','HLA-A24:13','HLA-A24:18',
                'HLA-A24:20','HLA-A24:21','HLA-A24:22','HLA-A24:23','HLA-A24:26','HLA-A24:27','HLA-A24:28','HLA-A24:29','HLA-A24:33',
                'HLA-A24:34','HLA-A24:35','HLA-A24:37','HLA-A24:38','HLA-A24:39','HLA-A24:40','HLA-A24:43','HLA-A24:46','HLA-A24:47',
                'HLA-A24:48','HLA-A24:49','HLA-A23:05','HLA-A23:12','HLA-A24:17','HLA-A24:25','HLA-A24:30','HLA-A24:41','HLA-A24:42',
                'HLA-A24:44','HLA-A24:52')
classified_A_supertypes=unique(c(A1_supertype,A2_supertype,A3_supertype,A24_supertype))
B7_supertype=c('HLA-B07:02','HLA-B07:03','HLA-B07:05','HLA-B15:08','HLA-B35:01','HLA-B35:03','HLA-B42:01','HLA-B51:01','HLA-B51:02',
               'HLA-B51:03','HLA-B53:01','HLA-B54:01','HLA-B55:01','HLA-B55:02','HLA-B56:01','HLA-B67:01','HLA-B78:01','HLA-B07:04',
               'HLA-B07:06','HLA-B07:15','HLA-B07:19','HLA-B07:20','HLA-B07:21','HLA-B07:22','HLA-B07:24','HLA-B07:25','HLA-B07:26',
               'HLA-B07:30','HLA-B07:31','HLA-B07:33','HLA-B07:34','HLA-B07:35','HLA-B07:39','HLA-B07:40','HLA-B07:41','HLA-B07:42',
               'HLA-B07:43','HLA-B35:07','HLA-B35:08','HLA-B35:11','HLA-B35:14','HLA-B35:15','HLA-B35:21','HLA-B35:22','HLA-B35:24',
               'HLA-B35:31','HLA-B35:32','HLA-B35:33','HLA-B35:35','HLA-B35:36','HLA-B35:38','HLA-B35:40','HLA-B35:41','HLA-B35:42',
               'HLA-B35:43','HLA-B35:44','HLA-B35:45','HLA-B35:46','HLA-B35:54','HLA-B35:55','HLA-B35:57','HLA-B35:61','HLA-B39:10',
               'HLA-B39:16','HLA-B42:04','HLA-B42:05','HLA-B51:05','HLA-B51:08','HLA-B51:09','HLA-B51:10','HLA-B51:11','HLA-B51:16',
               'HLA-B51:17','HLA-B51:18','HLA-B51:19','HLA-B51:21','HLA-B51:23','HLA-B51:24','HLA-B51:26','HLA-B51:28','HLA-B51:29',
               'HLA-B51:30','HLA-B51:31','HLA-B51:32','HLA-B51:33','HLA-B51:34','HLA-B51:35','HLA-B51:36','HLA-B51:38','HLA-B53:02',
               'HLA-B53:06','HLA-B53:08','HLA-B53:10','HLA-B54:03','HLA-B54:04','HLA-B54:06','HLA-B54:07','HLA-B55:03','HLA-B55:04',
               'HLA-B55:05','HLA-B55:07','HLA-B55:09','HLA-B55:10','HLA-B55:15','HLA-B55:17','HLA-B55:19','HLA-B56:03','HLA-B56:05',
               'HLA-B56:13','HLA-B56:15','HLA-B56:16','HLA-B78:02','HLA-B78:04','HLA-B07:07','HLA-B07:09','HLA-B07:12','HLA-B07:14',
               'HLA-B07:16','HLA-B07:17','HLA-B07:18','HLA-B07:23','HLA-B07:36','HLA-B07:37','HLA-B35:02','HLA-B35:04','HLA-B35:05',
               'HLA-B35:06','HLA-B35:09','HLA-B35:12','HLA-B35:17','HLA-B35:18','HLA-B35:29','HLA-B35:30','HLA-B35:34','HLA-B35:37',
               'HLA-B35:39','HLA-B35:51','HLA-B35:53','HLA-B35:58','HLA-B35:60','HLA-B38:06','HLA-B38:07','HLA-B39:17','HLA-B42:06',
               'HLA-B44:06','HLA-B51:04','HLA-B51:06','HLA-B51:12','HLA-B51:13','HLA-B51:14','HLA-B51:20','HLA-B51:37','HLA-B53:04',
               'HLA-B55:08','HLA-B55:11','HLA-B55:13','HLA-B55:14','HLA-B56:02','HLA-B56:04','HLA-B56:09','HLA-B56:10','HLA-B56:11',
               'HLA-B56:12','HLA-B81:01','HLA-B81:02')
B8_supertype=c('HLA-B08:01','HLA-B08:02','HLA-B08:07','HLA-B08:09','HLA-B08:11','HLA-B08:13','HLA-B08:15','HLA-B08:18','HLA-B08:19',
               'HLA-B08:20','HLA-B08:21','HLA-B08:22','HLA-B08:23','HLA-B08:24','HLA-B08:25','HLA-B08:03','HLA-B08:08','HLA-B08:12',
               'HLA-B08:16')
B27_supertype=c('HLA-B14:02','HLA-B15:03','HLA-B15:09','HLA-B15:10','HLA-B15:18','HLA-B27:02','HLA-B27:03','HLA-B27:04','HLA-B27:05',
                'HLA-B27:06','HLA-B27:07','HLA-B27:09','HLA-B38:01','HLA-B39:01','HLA-B39:02','HLA-B39:09','HLA-B48:01','HLA-B73:01',
                'HLA-B14:01','HLA-B14:03','HLA-B14:06','HLA-B14:07','HLA-B15:37','HLA-B15:47','HLA-B15:49','HLA-B15:51','HLA-B15:52',
                'HLA-B15:54','HLA-B15:61','HLA-B15:62','HLA-B15:69','HLA-B15:72','HLA-B15:74','HLA-B15:80','HLA-B15:90','HLA-B15:91',
                'HLA-B15:93','HLA-B15:98','HLA-B15:99','HLA-B27:10','HLA-B27:13','HLA-B27:15','HLA-B27:17','HLA-B27:25','HLA-B27:28',
                'HLA-B38:05','HLA-B38:09','HLA-B38:10','HLA-B38:11','HLA-B39:04','HLA-B39:07','HLA-B39:14','HLA-B39:18','HLA-B39:23',
                'HLA-B39:26','HLA-B39:27','HLA-B39:29','HLA-B39:30','HLA-B39:32','HLA-B40:12','HLA-B48:02','HLA-B48:03','HLA-B48:04',
                'HLA-B48:05','HLA-B48:09','HLA-B48:10','HLA-B48:11','HLA-B48:12','HLA-B48:13','HLA-B95:03','HLA-B14:05','HLA-B15:23',
                'HLA-B15:68','HLA-B27:01','HLA-B27:11','HLA-B27:14','HLA-B27:19','HLA-B27:20','HLA-B27:21','HLA-B27:24','HLA-B27:27',
                'HLA-B27:30','HLA-B35:26','HLA-B39:03','HLA-B39:05','HLA-B39:06','HLA-B39:08','HLA-B39:11','HLA-B39:13','HLA-B39:15',
                'HLA-B39:24','HLA-B39:28','HLA-B39:33','HLA-B39:34','HLA-B44:40','HLA-B48:07','HLA-B48:08','HLA-B55:18')
B44_supertype=c('HLA-B18:01','HLA-B37:01','HLA-B40:01','HLA-B40:02','HLA-B40:06','HLA-B44:02','HLA-B44:03','HLA-B45:01','HLA-B15:53',
                'HLA-B18:03','HLA-B18:05','HLA-B18:06','HLA-B18:10','HLA-B18:11','HLA-B18:13','HLA-B18:15','HLA-B18:19','HLA-B18:20',
                'HLA-B37:04','HLA-B40:05','HLA-B40:11','HLA-B40:14','HLA-B40:15','HLA-B40:16','HLA-B40:20','HLA-B40:26','HLA-B40:29',
                'HLA-B40:35','HLA-B40:39','HLA-B40:40','HLA-B40:49','HLA-B40:50','HLA-B40:53','HLA-B40:54','HLA-B40:55','HLA-B40:56',
                'HLA-B40:57','HLA-B41:02','HLA-B41:03','HLA-B44:04','HLA-B44:07','HLA-B44:13','HLA-B44:16','HLA-B44:21','HLA-B44:22',
                'HLA-B44:24','HLA-B44:26','HLA-B44:27','HLA-B44:28','HLA-B44:29','HLA-B44:30','HLA-B44:32','HLA-B44:33','HLA-B44:35',
                'HLA-B44:36','HLA-B44:37','HLA-B44:38','HLA-B45:03','HLA-B45:04','HLA-B45:05','HLA-B45:07','HLA-B49:04','HLA-B50:01',
                'HLA-B50:02','HLA-B50:04','HLA-B15:46','HLA-B18:02','HLA-B18:14','HLA-B40:03','HLA-B40:04','HLA-B40:09','HLA-B40:10',
                'HLA-B40:18','HLA-B40:19','HLA-B40:23','HLA-B40:24','HLA-B40:28','HLA-B40:30','HLA-B40:33','HLA-B40:34','HLA-B40:36',
                'HLA-B40:38','HLA-B40:42','HLA-B40:43','HLA-B40:44','HLA-B40:45','HLA-B40:47','HLA-B40:48','HLA-B40:51','HLA-B40:52',
                'HLA-B40:58','HLA-B40:59','HLA-B41:01','HLA-B41:04','HLA-B41:06','HLA-B41:07','HLA-B44:05','HLA-B44:14','HLA-B44:20',
                'HLA-B44:25','HLA-B44:31','HLA-B44:34','HLA-B44:39','HLA-B44:41','HLA-B44:42','HLA-B45:02','HLA-B47:04','HLA-B47:05')
B58_supertype=c('HLA-B15:16','HLA-B15:17','HLA-B57:01','HLA-B57:02','HLA-B58:01','HLA-B58:02','HLA-B15:67','HLA-B15:95','HLA-B57:03',
                'HLA-B57:07','HLA-B57:08','HLA-B57:09','HLA-B58:04','HLA-B58:06','HLA-B58:07','HLA-B58:08','HLA-B58:09','HLA-B58:11',
                'HLA-B57:04','HLA-B57:05','HLA-B57:06','HLA-B58:05')
B62_supertype=c('HLA-B15:01','HLA-B15:02','HLA-B15:12','HLA-B15:13','HLA-B46:01','HLA-B52:01','HLA-B15:05','HLA-B15:14','HLA-B15:15',
                'HLA-B15:19','HLA-B15:20','HLA-B15:25','HLA-B15:28','HLA-B15:30','HLA-B15:31','HLA-B15:33','HLA-B15:34','HLA-B15:38',
                'HLA-B15:39','HLA-B15:40','HLA-B15:48','HLA-B15:50','HLA-B15:60','HLA-B15:63','HLA-B15:65','HLA-B15:70','HLA-B15:75',
                'HLA-B15:78','HLA-B15:81','HLA-B15:82','HLA-B15:83','HLA-B15:85','HLA-B15:88','HLA-B15:92','HLA-B15:96','HLA-B15:97',
                'HLA-B35:28','HLA-B40:21','HLA-B46:03','HLA-B46:04','HLA-B46:05','HLA-B52:02','HLA-B52:03','HLA-B52:04','HLA-B52:05',
                'HLA-B52:07','HLA-B52:08','HLA-B78:05','HLA-B95:02','HLA-B95:04','HLA-B15:04','HLA-B15:07','HLA-B15:24','HLA-B15:35',
                'HLA-B15:42','HLA-B15:45','HLA-B15:55','HLA-B15:58','HLA-B15:73','HLA-B15:86','HLA-B44:08','HLA-B46:02','HLA-B13:09',
                'HLA-B13:13')
classified_B_supertypes=unique(c(B7_supertype,B8_supertype,B27_supertype,B44_supertype,B58_supertype,B62_supertype))

C1_supertype=c('HLA-C01:02','HLA-C01:03','HLA-C01:04','HLA-C01:05','HLA-C01:06','HLA-C01:07','HLA-C01:08','HLA-C01:09','HLA-C03:02',
               'HLA-C03:03','HLA-C03:04','HLA-C03:05','HLA-C03:06','HLA-C03:09','HLA-C03:11','HLA-C03:12','HLA-C03:13','HLA-C03:14','HLA-C03:16',
               'HLA-C07:02','HLA-C07:03','HLA-C07:04','HLA-C07:05','HLA-C07:08','HLA-C07:10','HLA-C07:11','HLA-C07:12','HLA-C07:13',
               'HLA-C07:14','HLA-C07:15','HLA-C07:17','HLA-C08:01','HLA-C08:02','HLA-C08:03','HLA-C08:04','HLA-C08:05','HLA-C08:06',
               'HLA-C08:07','HLA-C08:08','HLA-C08:09','HLA-C12:02','HLA-C12:03','HLA-C12:06','HLA-C12:07','HLA-C14:12','HLA-C14:13','HLA-C14:14',
               'HLA-C14:15','HLA-C16:01','HLA-C16:04')
C2_supertype=c('HLA-C02:02','HLA-C02:03','HLA-C02:04','HLA-C02:05','HLA-C02:06','HLA-C03:07','HLA-C03:08','HLA-C03:10','HLA-C03:15',
               'HLA-C04:01','HLA-C04:02','HLA-C04:03','HLA-C04:04','HLA-C04:05','HLA-C04:06','HLA-C04:07','HLA-C04:08','HLA-C04:09','HLA-C04:010',
               'HLA-C05:01','HLA-C05:02','HLA-C05:03','HLA-C05:04','HLA-C05:05','HLA-C05:06','HLA-C06:02','HLA-C06:03','HLA-C06:04','HLA-C06:05',
               'HLA-C06:06','HLA-C06:07','HLA-C06:08','HLA-C06:09','HLA-C07:01','HLA-C07:06','HLA-C07:07','HLA-C07:09','HLA-C07:16','HLA-C07:18',
               'HLA-C12:04','HLA-C12:05','HLA-C12:08','HLA-C15:02','HLA-C15:03','HLA-C15:04','HLA-C15:05','HLA-C15:06','HLA-C15:07','HLA-C15:08',
               'HLA-C15:09','HLA-C15:10','HLA-C15:11','HLA-C16:02','HLA-C17:01','HLA-C17:02','HLA-C17:03','HLA-C18:01','HLA-C18:02')
classified_C_supertypes=unique(c(C1_supertype,C2_supertype))


# Fig. 3A
dfList=list(ACC_immuneLandscape, BLCA_immuneLandscape, BRCA_immuneLandscape, CESC_immuneLandscape, CHOL_immuneLandscape, COAD_immuneLandscape, DLBC_immuneLandscape, GBM_immuneLandscape, HNSC_immuneLandscape, KICH_immuneLandscape, KIRC_immuneLandscape, KIRP_immuneLandscape, LGG_immuneLandscape, LIHC_immuneLandscape, LUAD_immuneLandscape, LUSC_immuneLandscape, MESO_immuneLandscape, PAAD_immuneLandscape, PCPG_immuneLandscape, PRAD_immuneLandscape, READ_immuneLandscape, SARC_immuneLandscape, SKCM_immuneLandscape, STAD_immuneLandscape, TGCT_immuneLandscape, THCA_immuneLandscape, THYM_immuneLandscape, UCEC_immuneLandscape, UCS_immuneLandscape, UVM_immuneLandscape)
HLA_supertypes=lapply(dfList, function(x) {
  #x = x %>% filter(tumor_HLA_G != 0) %>% filter(tumor_HLA_DOB != 0)
  #supertypes = data.frame(mean(log2(x$tumor_HLA_A + 1),na.rm=T), mean(log2(x$tumor_HLA_B + 1),na.rm=T), mean(log2(x$tumor_HLA_C + 1),na.rm=T), mean(log2(x$tumor_HLA_E + 1),na.rm=T), mean(log2(x$tumor_HLA_G + 1),na.rm=T), mean(log2(x$tumor_HLA_DR + 1),na.rm=T), mean(log2(x$tumor_HLA_DP + 1),na.rm=T), mean(log2(x$tumor_HLA_DQ + 1),na.rm=T), mean(log2(x$tumor_HLA_DM + 1),na.rm=T), mean(log2(x$tumor_HLA_DO + 1),na.rm=T))
  x=subset(x,!is.na(x$A1_firstField))
  x$A_classified=F
  x$B_classified=F
  x$C_classified=F
  
  A1_freq=0
  for (i in A1_supertype) {
    if (is.na(i)) {
      next
    }
    A1_freq=A1_freq+(length(grep(i,x$HLA_A1))+length(grep(i,x$HLA_A2)))/(nrow(x)*2)
    x$A_classified[c(grep(i,x$HLA_A1),grep(i,x$HLA_A2))]=T
  }
  A2_freq=0
  for (i in A2_supertype) {
    if (is.na(i)) {
      next
    }
    A2_freq=A2_freq+(length(grep(i,x$HLA_A1))+length(grep(i,x$HLA_A2)))/(nrow(x)*2)
    x$A_classified[c(grep(i,x$HLA_A1),grep(i,x$HLA_A2))]=T
  }
  A3_freq=0
  for (i in A3_supertype) {
    if (is.na(i)) {
      next
    }
    A3_freq=A3_freq+(length(grep(i,x$HLA_A1))+length(grep(i,x$HLA_A2)))/(nrow(x)*2)
    x$A_classified[c(grep(i,x$HLA_A1),grep(i,x$HLA_A2))]=T
  }
  A24_freq=0
  for (i in A24_supertype) {
    if (is.na(i)) {
      next
    }
    A24_freq=A24_freq+(length(grep(i,x$HLA_A1))+length(grep(i,x$HLA_A2)))/(nrow(x)*2)
    x$A_classified[c(grep(i,x$HLA_A1),grep(i,x$HLA_A2))]=T
  }
  
  B7_freq=0
  for (i in B7_supertype) {
    if (is.na(i)) {
      next
    }
    B7_freq=B7_freq+(length(grep(i,x$HLA_B1))+length(grep(i,x$HLA_B2)))/(nrow(x)*2)
    x$B_classified[c(grep(i,x$HLA_B1),grep(i,x$HLA_B2))]=T
  }
  B8_freq=0
  for (i in B8_supertype) {
    if (is.na(i)) {
      next
    }
    B8_freq=B8_freq+(length(grep(i,x$HLA_B1))+length(grep(i,x$HLA_B2)))/(nrow(x)*2)
    x$B_classified[c(grep(i,x$HLA_B1),grep(i,x$HLA_B2))]=T
  }
  B27_freq=0
  for (i in B27_supertype) {
    if (is.na(i)) {
      next
    }
    B27_freq=B27_freq+(length(grep(i,x$HLA_B1))+length(grep(i,x$HLA_B2)))/(nrow(x)*2)
    x$B_classified[c(grep(i,x$HLA_B1),grep(i,x$HLA_B2))]=T
  }
  B44_freq=0
  for (i in B44_supertype) {
    if (is.na(i)) {
      next
    }
    B44_freq=B44_freq+(length(grep(i,x$HLA_B1))+length(grep(i,x$HLA_B2)))/(nrow(x)*2)
    x$B_classified[c(grep(i,x$HLA_B1),grep(i,x$HLA_B2))]=T
  }
  B58_freq=0
  for (i in B58_supertype) {
    if (is.na(i)) {
      next
    }
    B58_freq=B58_freq+(length(grep(i,x$HLA_B1))+length(grep(i,x$HLA_B2)))/(nrow(x)*2)
    x$B_classified[c(grep(i,x$HLA_B1),grep(i,x$HLA_B2))]=T
  }
  B62_freq=0
  for (i in B62_supertype) {
    if (is.na(i)) {
      next
    }
    B62_freq=B62_freq+(length(grep(i,x$HLA_B1))+length(grep(i,x$HLA_B2)))/(nrow(x)*2)
    x$B_classified[c(grep(i,x$HLA_B1),grep(i,x$HLA_B2))]=T
  }
  
  C1_freq=0
  for (i in C1_supertype) {
    if (is.na(i)) {
      next
    }
    C1_freq=C1_freq+(length(grep(i,x$HLA_C1))+length(grep(i,x$HLA_C2)))/(nrow(x)*2)
    x$C_classified[c(grep(i,x$HLA_C1),grep(i,x$HLA_C2))]=T
  }
  C2_freq=0
  for (i in C2_supertype) {
    if (is.na(i)) {
      next
    }
    C2_freq=C2_freq+(length(grep(i,x$HLA_C1))+length(grep(i,x$HLA_C2)))/(nrow(x)*2)
    x$C_classified[c(grep(i,x$HLA_C1),grep(i,x$HLA_C2))]=T
  }
  
  supertype_freq=c(A1_freq,A2_freq,A3_freq,A24_freq,B7_freq,B8_freq,B27_freq,B44_freq,B58_freq,B62_freq,C1_freq,C2_freq)
  return(supertype_freq)
} )
combined_matrix <- data.frame(matrix(unlist(HLA_supertypes), nrow=length(HLA_supertypes), byrow=TRUE))
colnames(combined_matrix)=c('A1','A2','A3','A24','B7','B8','B27','B44','B58','B62','C1','C2')
rownames(combined_matrix)=c("ACC","BLCA","BRCA","CESC","CHOL","COAD","DLBC","GBM","HNSC","KICH","KIRC","KIRP","LGG","LIHC","LUAD","LUSC","MESO","PAAD","PCPG","PRAD","READ","SARC","SKCM","STAD","TGCT","THCA","THYM","UCEC","UCS","UVM")
data=as.matrix(combined_matrix)

annotation_col <- data.frame(row.names = c('A1','A2','A3','A24','B7','B8','B27','B44','B58','B62','C1','C2'), 
                             Supertypes = c(rep("HLA-A", 4), rep("HLA-B", 6), rep('HLA-C',2)))


annotation_colors = list(
  Supertypes = c("HLA-A" = "forestgreen","HLA-B" = 'thistle3','HLA-C' = 'deepskyblue3')
)
my_palette <- colorRampPalette(c("#5E3C99","white","#CD9B1D"))(200)
# heatmap.2(data,col= my_palette, scale = 'none', trace = "none", density.info = "none",key.xlab="Expression",keysize = 1)
# 620 * 540
pheatmap::pheatmap(data, color = my_palette, cluster_cols=F,cluster_rows=T,annotation_legend = T, 
                   annotation_names_row = F,annotation_names_col = F, show_rownames = T,
                   annotation_col=annotation_col, annotation_colors=annotation_colors,
                   border_color=T, legend=T, angle_col = "315")



# Fig. S3A-C
df=subset(df_immuneLandscape,!is.na(df_immuneLandscape$HLA_A1))
A1_index=c()
for (i in A1_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_A1),grep(i,df$HLA_A2))))
  A1_index=append(A1_index,index)
}
A2_index=c()
for (i in A2_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_A1),grep(i,df$HLA_A2))))
  A2_index=append(A2_index,index)
}
A3_index=c()
for (i in A3_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_A1),grep(i,df$HLA_A2))))
  A3_index=append(A3_index,index)
}
A24_index=c()
for (i in A24_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_A1),grep(i,df$HLA_A2))))
  A24_index=append(A24_index,index)
}
A1_index=unique(A1_index)
A2_index=unique(A2_index)
A3_index=unique(A3_index)
A24_index=unique(A24_index)

A1_df=df[A1_index,]
A2_df=df[A2_index,]
A3_df=df[A3_index,]
A24_df=df[A24_index,]

A1_df$supertype_A='A1'
A2_df$supertype_A='A2'
A3_df$supertype_A='A3'
A24_df$supertype_A='A24'

A_supertype_combined=rbind(A1_df,A2_df,A3_df,A24_df)
my_comparisons <- list( c('A1','A2'), c('A2', 'A3'))
# 650 * 400
ggplot(A_supertype_combined, aes(x=supertype_A, y=A_supertype_combined$HLA_A_log, fill=supertype_A)) + 
  geom_violin() + 
  stat_compare_means(label.x = 1, label.y = 15) +
  geom_boxplot(width=0.1) + 
  theme_bw() +
  guides(fill = F) +
  scale_fill_brewer(palette="Blues") + xlab('HLA-A Supertypes') + ylab('HLA-A Expression')

B7_index=c()
for (i in B7_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_B1),grep(i,df$HLA_B2))))
  B7_index=append(B7_index,index)
}
B8_index=c()
for (i in B8_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_B1),grep(i,df$HLA_B2))))
  B8_index=append(B8_index,index)
}
B27_index=c()
for (i in B27_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_B1),grep(i,df$HLA_B2))))
  B27_index=append(B27_index,index)
}
B44_index=c()
for (i in B44_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_B1),grep(i,df$HLA_B2))))
  B44_index=append(B44_index,index)
}
B58_index=c()
for (i in B58_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_B1),grep(i,df$HLA_B2))))
  B58_index=append(B58_index,index)
}
B62_index=c()
for (i in B62_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_B1),grep(i,df$HLA_B2))))
  B62_index=append(B62_index,index)
}
B7_index=unique(B7_index)
B8_index=unique(B8_index)
B27_index=unique(B27_index)
B44_index=unique(B44_index)
B58_index=unique(B58_index)
B62_index=unique(B62_index)

B7_df=df[B7_index,]
B8_df=df[B8_index,]
B27_df=df[B27_index,]
B44_df=df[B44_index,]
B58_df=df[B58_index,]
B62_df=df[B62_index,]

B7_df$supertype_B='B7'
B8_df$supertype_B='B8'
B27_df$supertype_B='B27'
B44_df$supertype_B='B44'
B58_df$supertype_B='B58'
B62_df$supertype_B='B62'

A_supertype_combined=rbind(B7_df,B8_df,B27_df,B44_df,B58_df,B62_df)
my_comparisons <- list( c('A1','A2'), c('A2', 'A3'), c('A3', 'A24') )
# 650 * 400
ggplot(A_supertype_combined, aes(x=supertype_B, y=A_supertype_combined$HLA_B_log, fill=supertype_B)) + 
  geom_violin() + 
  stat_compare_means(label.x = 1, label.y = 15) +
  geom_boxplot(width=0.1) + 
  theme_bw() +
  guides(fill = F) +
  scale_fill_brewer(palette="Blues") + xlab('HLA-B Supertypes') + ylab('HLA-B Expression')


C1_index=c()
for (i in C1_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_C1),grep(i,df$HLA_C2))))
  C1_index=append(C1_index,index)
}
C2_index=c()
for (i in C2_supertype) {
  if (is.na(i)) {
    next
  }
  index=c(unique(c(grep(i,df$HLA_C1),grep(i,df$HLA_C2))))
  C2_index=append(C2_index,index)
}
C1_index=unique(C1_index)
C2_index=unique(C2_index)
C1_df=df[C1_index,]
C2_df=df[C2_index,]
C1_df$supertype_C='C1'
C2_df$supertype_C='C2'
A_supertype_combined=rbind(C1_df,C2_df)
# 650 * 400
ggplot(A_supertype_combined, aes(x=supertype_C, y=A_supertype_combined$HLA_C_log, fill=supertype_C)) + 
  geom_violin() + 
  stat_compare_means(label.x = 1, label.y = 15) +
  geom_boxplot(width=0.1) + 
  theme_bw() +
  guides(fill = F) +
  scale_fill_brewer(palette="Blues") + xlab('HLA-C Supertypes') + ylab('HLA-C Expression')


# Fig. S3D
dfList=list(A1_df,A2_df,A3_df,A24_df,B7_df,B8_df,B27_df,B44_df,B58_df,B62_df,C1_df,C2_df)
HLA_supertypes=lapply(dfList, function(x) {
  df=subset(x,select=(c("geom_HLAII","T.cells.CD8","T.cells.CD4.memory.activated",'Th1.cells','Th2.cells','Th17.cells',"T.cells.regulatory.Tregs","NK.cells.activated","Macrophages.M1","Macrophages.M2")))
  matrix_df=corr.test(df, method = "spearman",use = "complete", adjust = 'fdr')
  matrix=matrix_df$r
  matrix_p=matrix_df$p
  mat=data.frame(matrix)
  colnames(mat)=c("HLA-II","CD8 Tc1","CD4 Tmem",'Th1','Th2','Th17',"Tregs","NK","M1","M2")
  row=mat[1,]
  return(row)
} )
HLAII_matrix <- data.frame(matrix(unlist(HLA_supertypes), nrow=length(HLA_supertypes), byrow=TRUE))
colnames(HLAII_matrix)=c("HLA-II","CD8 Tc1","CD4 Tmem",'Th1','Th2','Th17',"Tregs","NK","M1","M2")
rownames(HLAII_matrix)=c('A1','A2','A3','A24','B7','B8','B27','B44','B58','B62','C1','C2')
HLAII_matrix=HLAII_matrix[2:ncol(HLAII_matrix)]

my_palette <- colorRampPalette(c("deepskyblue4","white","firebrick3"))(200)
annotation_col <- data.frame(row.names = c("CD8 Tc1","CD4 Tmem",'Th1','Th2','Th17',"Tregs","NK","M1","M2"), 
                             Immunogenicity = c(rep("Immune Infiltration", 9)))
annotation_row <- data.frame(row.names = c('A1','A2','A3','A24','B7','B8','B27','B44','B58','B62','C1','C2'), 
                             Supertypes = c(rep("HLA-A", 4), rep("HLA-B", 6), rep('HLA-C',2)))
annotation_colors = list(
  Immunogenicity = c("Immune Infiltration" = "firebrick"),
  Supertypes = c("HLA-A" = "forestgreen","HLA-B" = 'thistle3','HLA-C' = 'deepskyblue3')
)

my_palette <- colorRampPalette(c("#5E3C99","white","#CD9B1D"))(200)
# 750 * 650
pheatmap::pheatmap(HLAII_matrix, color = my_palette, cluster_cols=T,cluster_rows=T,annotation_legend = T, 
                   annotation_names_row = F,annotation_names_col = F, show_rownames = T,
                   annotation_col=annotation_col, annotation_row=annotation_row, annotation_colors=annotation_colors,
                   border_color=T, legend=T, angle_col = "315")

# Fig. S3E
dfList=list(A1_df,A2_df,A3_df,A24_df,B7_df,B8_df,B27_df,B44_df,B58_df,B62_df,C1_df,C2_df)
HLA_supertypes=lapply(dfList, function(x) {
  df=subset(x,select=(c("IDO1_log",'CXCL9_log','CXCL10_log','STAT1_log','IFNG_log',"PDCD1_log","CD274_log","CTLA4_log","LAG3_log","TIGIT_log","HAVCR2_log")))
  matrix_df=corr.test(df, method = "spearman",use = "complete", adjust = 'fdr')
  matrix=matrix_df$r
  matrix_p=matrix_df$p
  mat=data.frame(matrix)
  colnames(mat)=c("IDO1",'CXCL9','CXCL10','STAT1','IFNG',"PDCD1","CD274","CTLA4","LAG3","TIGIT",'HAVCR2')
  row=mat[1,]
  return(row)
} )
HLAII_matrix <- data.frame(matrix(unlist(HLA_supertypes), nrow=length(HLA_supertypes), byrow=TRUE))
colnames(HLAII_matrix)=c("IDO1",'CXCL9','CXCL10','STAT1','IFNG',"PDCD1","CD274","CTLA4", "LAG3","TIGIT",'HAVCR2')
rownames(HLAII_matrix)=c('A1','A2','A3','A24','B7','B8','B27','B44','B58','B62','C1','C2')

my_palette <- colorRampPalette(c("deepskyblue4","white","firebrick3"))(200)
annotation_col <- data.frame(row.names = c("IDO1",'CXCL9','CXCL10','STAT1','IFNG',"PDCD1","CD274","CTLA4", "LAG3","TIGIT",'HAVCR2'), 
                             Immunogenicity = c(rep("Proinflammatory Genes", 5), rep("Immune Checkpoints", 6)))
annotation_row <- data.frame(row.names = c('A1','A2','A3','A24','B7','B8','B27','B44','B58','B62','C1','C2'), 
                             Supertypes = c(rep("HLA-A", 4), rep("HLA-B", 6), rep('HLA-C',2)))
annotation_colors = list(
  Immunogenicity = c("Proinflammatory Genes" = 'turquoise4',"Immune Checkpoints" = 'tan2'),
  Supertypes = c("HLA-A" = "forestgreen","HLA-B" = 'thistle3','HLA-C' = 'deepskyblue3')
)

my_palette <- colorRampPalette(c("#5E3C99","white","#CD9B1D"))(200)
# 750 * 650
pheatmap::pheatmap(HLAII_matrix, color = my_palette, cluster_cols=T,cluster_rows=T,annotation_legend = T, 
                   annotation_names_row = F,annotation_names_col = F, show_rownames = T,
                   annotation_col=annotation_col, annotation_row=annotation_row, annotation_colors=annotation_colors,
                   border_color=T, legend=T, angle_col = "315")




# Fig. S4: HLA-A allele groups
HLAdefined_df=subset(df_immuneLandscape,!is.na(df_immuneLandscape$A1_firstField))
homozygous_df=subset(HLAdefined_df,HLAdefined_df$A1_firstField == HLAdefined_df$A2_firstField & HLAdefined_df$A1_firstField != 'A25')
homozygous_df$`Allele Groups`=paste0('A*',substring(homozygous_df$A1_firstField,2))
allele_vec=levels(factor(homozygous_df$`Allele Groups`))
allele_vec[1]='A*02'
allele_vec[2]='A*01'
homozygous_df$`Allele Groups`=factor(homozygous_df$`Allele Groups`, allele_vec)

model <- coxph( Surv(PFI_time_1, PFI_1) ~ `Allele Groups`, data = homozygous_df)
# Image: 600 * 670
ggforest(model, main = "",
         fontsize = 0.7,
         refLabel = "reference",
         noDigits = 2)

# HLA-B allele group
HLAdefined_df=subset(df_immuneLandscape,!is.na(df_immuneLandscape$B1_firstField))
homozygous_df=subset(HLAdefined_df,HLAdefined_df$B1_firstField == HLAdefined_df$B2_firstField & HLAdefined_df$B1_firstField != 'B39' & HLAdefined_df$B1_firstField != 'B48' & HLAdefined_df$B1_firstField != 'B49' & HLAdefined_df$B1_firstField != 'B52' & HLAdefined_df$B1_firstField != 'B53' & HLAdefined_df$B1_firstField != 'B54' & HLAdefined_df$B1_firstField != 'B55' & HLAdefined_df$B1_firstField != 'B81')
homozygous_df$`Allele Groups`=paste0('B*',substring(homozygous_df$B1_firstField,2))
allele_vec=levels(factor(homozygous_df$`Allele Groups`))
allele_vec2=c("B*44","B*07","B*08","B*13","B*14","B*15","B*18","B*27","B*35","B*37","B*38","B*40","B*42","B*45","B*46","B*50","B*51","B*57","B*58")
homozygous_df$`Allele Groups`=factor(homozygous_df$`Allele Groups`, allele_vec2)
model <- coxph( Surv(PFI_time_1, PFI_1) ~ `Allele Groups`, data = homozygous_df)
# Image: 600 * 670
ggforest(model, main = "",
         fontsize = 0.7,
         refLabel = "reference",
         noDigits = 2)

# HLA-C allele group
HLAdefined_df=subset(df_immuneLandscape,!is.na(df_immuneLandscape$C1_firstField))
homozygous_df=subset(HLAdefined_df,HLAdefined_df$C1_firstField == HLAdefined_df$C2_firstField)
homozygous_df$`Allele Groups`=paste0('C*',substring(homozygous_df$C1_firstField,2))
allele_vec=levels(factor(homozygous_df$`Allele Groups`))
allele_vec2=c("C*01","C*02","C*03","C*04","C*05","C*06","C*07","C*08","C*12","C*14","C*15","C*16","C*17","C*18")
homozygous_df$`Allele Groups`=factor(homozygous_df$`Allele Groups`, allele_vec2)
model <- coxph( Surv(PFI_time_1, PFI_1) ~ `Allele Groups`, data = homozygous_df)
# Image: 600 * 670
ggforest(model, main = "",
         fontsize = 0.7,
         refLabel = "reference",
         noDigits = 2)